syntax = "proto3";
package sfu;

import "proto/signaling.proto";

option go_package = "github.com/RoseWrightdev/Video-Conferencing/backend/go/gen/proto; proto";

// SfuService defines the gRPC interface for the Rust Selective Forwarding Unit (SFU).
// It handles peer session management, signaling, and media routing in the Data Plane.
service SfuService {
  // CreateSession initializes a new WebRTC session for a peer in the Rust SFU.
  // The SFU acts as the "passive" side (or answerer) in most cases, but here it
  // prepares resources and may return an SDP offer if configured to initiate.
  // In the current architecture:
  // 1. Backend calls CreateSession
  // 2. SFU creates PeerConnection
  // 3. SFU returns CreateSessionResponse (containing SDP Offer)
  rpc CreateSession (CreateSessionRequest) returns (CreateSessionResponse);

  // HandleSignal forwards protocol messages (SDP Answer, ICE Candidates) from the Client
  // to the SFU. This allows the SFU to complete the WebRTC handshake.
  rpc HandleSignal (SignalMessage) returns (SignalResponse);

  // DeleteSession tears down a peer's WebRTC session and releases all associated resources
  // (transceivers, tracks, ports).
  rpc DeleteSession (DeleteSessionRequest) returns (DeleteSessionResponse);

  // ListenEvents establishes a server-side stream to receive asynchronous events from the SFU.
  // Events include:
  // - New tracks published by other peers
  // - ICE candidates generated by the SFU
  // - Renegotiation requests
  rpc ListenEvents (ListenRequest) returns (stream SfuEvent);
}

// CreateSessionRequest is the payload to initialize a new session.
message CreateSessionRequest {
  string room_id = 1; // Unique identifier for the conference room
  string user_id = 2; // Unique identifier for the participant
}

// CreateSessionResponse contains the initial signaling data from the SFU.
message CreateSessionResponse {
  string sdp_offer = 1; // The SDP Offer generated by the SFU's PeerConnection
}

// SignalMessage carries WebRTC signaling data from the Go Backend (proxying the Client) to the SFU.
message SignalMessage {
  string room_id = 1; // Unqiue identifier for the conference room
  string user_id = 2; // Unique identifier for the participant
  
  // The specific signaling payload
  oneof payload {
    string sdp_answer = 3;  // SDP Answer from the client (in response to SFU's Offer)
    string ice_candidate = 4; // Trickle ICE candidate from the client
    string sdp_offer = 5;   // SDP Offer from the client (for renegotiation)
  }
}

// SignalResponse indicates whether the SFU successfully processed the signal.
message SignalResponse {
  bool success = 1;
}

// DeleteSessionRequest asks the SFU to disconnect a user.
message DeleteSessionRequest {
  string room_id = 1; // Unique identifier for the conference room
  string user_id = 2; // Unique identifier for the participant (peer to remove)
}

// DeleteSessionResponse indicates success of the teardown operation.
message DeleteSessionResponse {
  bool success = 1;
}

// ListenRequest establishes the event stream for a specific session.
message ListenRequest {
  string room_id = 1; 
  string user_id = 2;
}

// SfuEvent represents an asynchronous event occurring within the SFU that the Backend/Client needs to know about.
message SfuEvent {
  oneof payload {
    string track_added_user_id = 1 [deprecated = true]; // DEPRECATED: Use track_event
    string track_added_stream_id = 2 [deprecated = true]; // DEPRECATED: Use track_event
    
    // Notification that a new track has been added to the room.
    // The Backend should relay this to clients so they can subscribe.
    .signaling.TrackAddedEvent track_event = 3; 

    // Request to renegotiate the WebRTC connection.
    string renegotiate_sdp_offer = 4;
    
    // SDP Answer generated by the SFU (in response to a client's Offer).
    string sdp_answer = 5;
    
    // Trickle ICE candidate generated by the SFU.
    // The Backend should forward this to the specific client.
    string ice_candidate = 6;
    
    // Caption event to be forwarded to clients.
    .signaling.CaptionEvent caption = 7;
  }
}
