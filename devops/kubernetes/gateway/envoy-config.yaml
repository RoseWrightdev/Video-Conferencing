---
# EnvoyProxy Configuration for Video Conferencing Gateway
# This configures Envoy-specific settings for the gateway

apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyProxy
metadata:
  name: video-conferencing-proxy
  namespace: video-conferencing
  labels:
    app.kubernetes.io/name: envoy-proxy
    app.kubernetes.io/component: gateway
spec:
  # Provider-specific configuration
  provider:
    type: Kubernetes
    kubernetes:
      envoyDeployment:
        replicas: 3
        
        # Pod configuration
        pod:
          labels:
            app.kubernetes.io/name: envoy
            app.kubernetes.io/component: proxy
          
          # Resource limits for Envoy proxies
          resources:
            requests:
              cpu: "500m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
        
        # Service configuration
        envoyService:
          type: LoadBalancer
          annotations:
            # AWS-specific annotations (adjust for your cloud provider)
            service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
            service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
  
  # Telemetry configuration
  telemetry:
    accessLog:
      settings:
      - format:
          type: JSON
          json:
            authority: "%REQ(:AUTHORITY)%"
            bytes_received: "%BYTES_RECEIVED%"
            bytes_sent: "%BYTES_SENT%"
            duration: "%DURATION%"
            method: "%REQ(:METHOD)%"
            path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
            protocol: "%PROTOCOL%"
            request_id: "%REQ(X-REQUEST-ID)%"
            response_code: "%RESPONSE_CODE%"
            response_flags: "%RESPONSE_FLAGS%"
            upstream_service_time: "%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%"
            user_agent: "%REQ(USER-AGENT)%"
            x_forwarded_for: "%REQ(X-FORWARDED-FOR)%"
        sinks:
        - type: File
          file:
            path: /dev/stdout
    
    # Prometheus metrics
    metrics:
    - type: Prometheus
      prometheus:
        disable: false
  
  # Bootstrap configuration for advanced settings
  bootstrap:
    type: Replace
    value: |
      admin:
        access_log:
        - name: envoy.access_loggers.file
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
            path: /dev/stdout
        address:
          socket_address:
            address: 127.0.0.1
            port_value: 19000
      
      static_resources:
        listeners:
        - name: envoy-gateway-system
          address:
            socket_address:
              address: 0.0.0.0
              port_value: 10080
          filter_chains:
          - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http
                codec_type: AUTO
                route_config:
                  name: local_route
                  virtual_hosts:
                  - name: local_service
                    domains: ["*"]
                    routes:
                    - match:
                        prefix: "/"
                      route:
                        cluster: service
                http_filters:
                - name: envoy.filters.http.router
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
                # WebSocket upgrade configuration
                upgrade_configs:
                - upgrade_type: websocket
        
        clusters:
        - name: service
          connect_timeout: 5s
          type: STRICT_DNS
          lb_policy: ROUND_ROBIN
          load_assignment:
            cluster_name: service
            endpoints:
            - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: backend-service
                      port_value: 8080
          # WebSocket keep-alive settings
          http2_protocol_options:
            connection_keepalive:
              interval: 30s
              timeout: 5s
