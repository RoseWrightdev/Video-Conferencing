name: Video Conferencing CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ------------------------------------------------------------------
  # Backend (Go) Checks
  # ------------------------------------------------------------------
  backend-checks:
    name: Backend (Go)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'

    - name: Verify dependencies
      run: |
        cd backend/go
        go mod verify

    - name: Run Vetting
      run: |
        cd backend/go
        go vet ./...

    - name: Run Tests
      run: |
        cd backend/go
        go test -v ./...

  # ------------------------------------------------------------------
  # Frontend (Next.js) Checks
  # ------------------------------------------------------------------
  frontend-checks:
    name: Frontend (Node)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    - name: Lint
      run: |
        cd frontend
        npm run lint

    # Assuming 'npm test' or 'npm run test' exists
    - name: Test
      run: |
        cd frontend
        npm test -- --passWithNoTests

  # ------------------------------------------------------------------
  # SFU (Rust) Checks
  # ------------------------------------------------------------------
  sfu-checks:
    name: SFU (Rust)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
         toolchain: '1.75'

    - name: Install Protobuf Compiler (protoc)
      run: sudo apt-get install -y protobuf-compiler

    - name: Check
      run: |
        cd backend/rust/sfu
        cargo check --verbose

    - name: Test
      run: |
        cd backend/rust/sfu
        cargo test --verbose

  # ------------------------------------------------------------------
  # Build & Publish Images (Mock)
  # ------------------------------------------------------------------
  build-and-push:
    name: Build & Push Docker Images
    needs: [backend-checks, frontend-checks, sfu-checks]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    # In a real setup, you would log in to GHCR or Docker Hub
    # - name: Login to GitHub Container Registry
    #   uses: docker/login-action@v3
    #   with:
    #     registry: ghcr.io
    #     username: ${{ github.actor }}
    #     password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build Backend Image
      run: |
        echo "Building backend..."
        # docker build -f devops/docker/backend.dockerfile -t ghcr.io/user/backend:${{ github.sha }} .
        # docker push ghcr.io/user/backend:${{ github.sha }}
        
    - name: Build Frontend Image
      run: |
        echo "Building frontend..."
        # docker build -f devops/docker/frontend.dockerfile -t ghcr.io/user/frontend:${{ github.sha }} .
        
    - name: Build SFU Image
      run: |
        echo "Building SFU..."
        # docker build -f devops/docker/rust-sfu.dockerfile -t ghcr.io/user/rust-sfu:${{ github.sha }} .
